A set of shared utility functions specifically for the purpose of modifying native browser APIs without leaving traces.

Meant to be passed down in puppeteer and used in the context of the page.

Note: If for whatever reason you need to use this outside of `puppeteer-extra` or NodeJS:
Just remove the `module.exports` and everything below it, the rest can be copy pasted into any browser context.

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

- [utils()](#utils)
  - [.stripProxyFromErrors(handler)](#stripproxyfromerrorshandler)
  - [.stripErrorWithAnchor(err, anchor)](#striperrorwithanchorerr-anchor)
  - [.replaceProperty(obj, propName, descriptorOverrides)](#replacepropertyobj-propname-descriptoroverrides)
  - [.preloadCache()](#preloadcache)
  - [.makeNativeString(name?)](#makenativestringname)
  - [.patchToString(obj, str)](#patchtostringobj-str)
  - [.patchToStringNested(obj)](#patchtostringnestedobj)
  - [.redirectToString(proxyObj, originalObj)](#redirecttostringproxyobj-originalobj)
  - [.replaceWithProxy(obj, propName, handler)](#replacewithproxyobj-propname-handler)
  - [.mockWithProxy(obj, propName, pseudoTarget, handler)](#mockwithproxyobj-propname-pseudotarget-handler)
  - [.splitObjPath(objPath)](#splitobjpathobjpath)
  - [.replaceObjPathWithProxy(objPath, handler)](#replaceobjpathwithproxyobjpath-handler)
  - [.execRecursively(obj, typeFilter, fn)](#execrecursivelyobj-typefilter-fn)
- [evaluate(page, fn, args)](#evaluatepage-fn-args)
- [evaluateOnNewDocument(page, fn, args)](#evaluateonnewdocumentpage-fn-args)

### [utils()](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L438-L440)

---

#### .[stripProxyFromErrors(handler)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L20-L81)

- `handler` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The JS Proxy handler to wrap (optional, default `{}`)

Wraps a JS Proxy Handler and strips it's presence from error stacks, in case the traps throw.

The presence of a JS Proxy can be revealed as it shows up in error stack traces.

---

#### .[stripErrorWithAnchor(err, anchor)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L89-L100)

- `err` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The error to sanitize
- `anchor` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The string the anchor line starts with

Strip error lines from stack traces until (and including) a known line the stack.

---

#### .[replaceProperty(obj, propName, descriptorOverrides)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L119-L126)

- `obj` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The object which has the property to replace
- `propName` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The property name to replace
- `descriptorOverrides` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** e.g. { value: "alice" } (optional, default `{}`)

Replace the property of an object in a stealthy way.

Note: You also want to work on the prototype of an object most often,
as you'd otherwise leave traces (e.g. showing up in Object.getOwnPropertyNames(obj)).

Example:

```javascript
replaceProperty(WebGLRenderingContext.prototype, 'getParameter', {
  value: 'alice'
})
// or
replaceProperty(Object.getPrototypeOf(navigator), 'languages', {
  get: () => ['en-US', 'en']
})
```

- **See: <https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty>**

---

#### .[preloadCache()](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L136-L149)

Preload a cache of function copies and data.

For a determined enough observer it would be possible to overwrite and sniff usage of functions
we use in our internal Proxies, to combat that we use a cached copy of those functions.

This is evaluated once per execution context (e.g. window)

---

#### .[makeNativeString(name?)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L168-L172)

- `name` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** Optional function name (optional, default `''`)

Utility function to generate a cross-browser `toString` result representing native code.

There's small differences: Chromium uses a single line, whereas FF & Webkit uses multiline strings.
To future-proof this we use an existing native toString result as the basis.

The only advantage we have over the other team is that our JS runs first, hence we cache the result
of the native toString result once, so they cannot spoof it afterwards and reveal that we're using it.

Note: Whenever we add a `Function.prototype.toString` proxy we should preload the cache before,
by executing `utils.preloadCache()` before the proxy is applied (so we don't cause recursive lookups).

Example:

```javascript
makeNativeString('foobar') // => `function foobar() { [native code] }`
```

---

#### .[patchToString(obj, str)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L188-L217)

- `obj` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The object for which to modify the `toString()` representation
- `str` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Optional string used as a return value (optional, default `''`)

Helper function to modify the `toString()` result of the provided object.

Note: Use `utils.redirectToString` instead when possible.

There's a quirk in JS Proxies that will cause the `toString()` result to differ from the vanilla Object.
If no string is provided we will generate a `[native code]` thing based on the name of the property object.

Example:

```javascript
patchToString(
  WebGLRenderingContext.prototype.getParameter,
  'function getParameter() { [native code] }'
)
```

---

#### .[patchToStringNested(obj)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L224-L226)

- `obj` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** (optional, default `{}`)

Make all nested functions of an object native.

---

#### .[redirectToString(proxyObj, originalObj)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L234-L271)

- `proxyObj` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The object that toString will be called on
- `originalObj` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The object which toString result we wan to return

Redirect toString requests from one object to another.

---

#### .[replaceWithProxy(obj, propName, handler)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L286-L295)

- `obj` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The object which has the property to replace
- `propName` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The name of the property to replace
- `handler` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The JS Proxy handler to use

All-in-one method to replace a property with a JS Proxy using the provided Proxy handler with traps.

Will stealthify these aspects (strip error stack traces, redirect toString, etc).
Note: This is meant to modify native Browser APIs and works best with prototype objects.

Example:

```javascript
replaceWithProxy(WebGLRenderingContext.prototype, 'getParameter', proxyHandler)
```

---

#### .[mockWithProxy(obj, propName, pseudoTarget, handler)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L310-L318)

- `obj` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The object which has the property to replace
- `propName` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The name of the property to replace or create
- `pseudoTarget` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The JS Proxy target to use as a basis
- `handler` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The JS Proxy handler to use

All-in-one method to mock a non-existing property with a JS Proxy using the provided Proxy handler with traps.

Will stealthify these aspects (strip error stack traces, redirect toString, etc).

Example:

```javascript
mockWithProxy(
  chrome.runtime,
  'sendMessage',
  function sendMessage() {},
  proxyHandler
)
```

---

#### .[splitObjPath(objPath)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L329-L337)

- `objPath` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The full path to an object as dot notation string

Helper function to split a full path to an Object into the first part and property.

Example:

```javascript
splitObjPath(`HTMLMediaElement.prototype.canPlayType`)
// => {objName: "HTMLMediaElement.prototype", propName: "canPlayType"}
```

---

#### .[replaceObjPathWithProxy(objPath, handler)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L350-L354)

- `objPath` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The full path to an object (dot notation string) to replace
- `handler` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The JS Proxy handler to use

Convenience method to replace a property with a JS Proxy using the provided objPath.

Supports a full path (dot notation) to the object as string here, in case that makes it easier.

Example:

```javascript
replaceObjPathWithProxy(
  'WebGLRenderingContext.prototype.getParameter',
  proxyHandler
)
```

---

#### .[execRecursively(obj, typeFilter, fn)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L363-L380)

- `obj` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** (optional, default `{}`)
- `typeFilter` **[array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)** e.g. `['function']` (optional, default `[]`)
- `fn` **[Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** e.g. `utils.patchToString`

Traverse nested properties of an object recursively and apply the given function on a whitelist of value types.

---

### [evaluate(page, fn, args)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L418-L429)

- `page`
- `fn`
- `args` (optional, default `{}`)

Simple `page.evaluate` replacement to preload utils

---

### [evaluateOnNewDocument(page, fn, args)](https://github.com/berstend/puppeteer-extra/blob/ceca9c6fed0a9f39d6c80b71fd413f3656ebb704/packages/puppeteer-extra-plugin-stealth/evasions/_utils/index.js#L434-L446)

- `page`
- `fn`
- `args` (optional, default `{}`)

Simple `page.evaluateOnNewDocument` replacement to preload utils

---
