language: node_js
dist: trusty
addons:
  apt:
    packages:
      # This is required to run new chrome on old trusty
      - libnss3

language: node_js

# allow headful tests
before_install:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"

# test against multiple node versions
node_js:
- '13'
- '8'
# - '9'

# Fix for: error fsevents@2.1.2: The platform "linux" is incompatible with this module.
install: skip

# test against multiple puppeteer versions
env:
  - PUPPETEER_VERSION=2.0.0 # Chromium 79.0.3942.0, Oct 24 2019
  - PUPPETEER_VERSION=1.20.0 # Chromium 78.0.3882.0, Sep 13 2019
  - PUPPETEER_VERSION=1.15.0 # Chromium 75.0.3765.0, Apr 26 2019
  - PUPPETEER_VERSION=1.9.0 # Chromium 71.0.3563.0, Oct 4, 2018
  - PUPPETEER_VERSION=1.6.2 # Chromium 69.0.3494.0, Aug 1, 2018

  # - PUPPETEER_VERSION=next
  # # - PUPPETEER_VERSION=1.11.0
  # - PUPPETEER_VERSION=1.10.0
  # - PUPPETEER_VERSION=1.9.0
  # - PUPPETEER_VERSION=1.7.0
  # - PUPPETEER_VERSION=1.6.2
  # - PUPPETEER_VERSION=1.4.0

script:
  # Make sure to use latest @next package
  # https://github.com/yarnpkg/yarn/issues/4731
  # - 'if [ "$PUPPETEER_VERSION" = "next" ]; then rm -rf yarn.lock && rm -rf ./node_modules/puppeteer && lerna add puppeteer@next && yarn --ignore-optional; fi'

  # Install older version when required

  - 'yarn config set ignore-engines true && yarn add --ignore-optional --ignore-workspace-root-check lerna && rm -rf yarn.lock && rm -rf ./node_modules/puppeteer && yarn lerna add puppeteer@${PUPPETEER_VERSION} && yarn --ignore-optional'
  # - 'yarn add lerna && rm -rf yarn.lock && rm -rf ./node_modules/puppeteer && yarn lerna add puppeteer@${PUPPETEER_VERSION} && yarn --ignore-optional'

  # - 'if [ "$PUPPETEER_VERSION" = "1.11.0" ]; then rm -rf yarn.lock && rm -rf ./node_modules/puppeteer && lerna add puppeteer@1.11.0 && yarn --ignore-optional; fi'
  # - 'if [ "$PUPPETEER_VERSION" = "1.11.0" ]; then rm -rf yarn.lock && rm -rf ./node_modules/puppeteer && lerna add puppeteer@1.10.0 && yarn --ignore-optional; fi'
  # - 'if [ "$PUPPETEER_VERSION" = "1.11.0" ]; then rm -rf yarn.lock && rm -rf ./node_modules/puppeteer && lerna add puppeteer@1.9.0 && yarn --ignore-optional; fi'
  # - 'if [ "$PUPPETEER_VERSION" = "1.11.0" ]; then rm -rf yarn.lock && rm -rf ./node_modules/puppeteer && lerna add puppeteer@1.7.0 && yarn --ignore-optional; fi'
  # - 'if [ "$PUPPETEER_VERSION" = "1.11.0" ]; then rm -rf yarn.lock && rm -rf ./node_modules/puppeteer && lerna add puppeteer@1.6.2 && yarn --ignore-optional; fi'
  # - 'if [ "$PUPPETEER_VERSION" = "1.11.0" ]; then rm -rf yarn.lock && rm -rf ./node_modules/puppeteer && lerna add puppeteer@1.4.0 && yarn --ignore-optional; fi'

  # For debugging
  - yarn list puppeteer

  # Run tests
  - yarn test-ci
